# 组合模式

假设你想做一个文件管理系统，这个文件管理系统是一个树形结构，最顶层是一个文件夹，里面可以包含各种文件和文件夹，文件夹里面还可以继续包含各种文件和文件夹，以此类推，直到所有的叶子节点。

在这个文件系统中，可能存在很多种格式的文件，如果图片，文本文件、视频文件等等，这些不同的格式文件的浏览方式都不同，同时对文件夹的浏览就是对文件夹中文件的浏览，但是对于客户而言都是浏览文件，两者之间不存在什么本质的差别。

![folder-and-file](https://tva1.sinaimg.cn/large/008i3skNgy1gt5t774ei3j30mw0dkjro.jpg)

基于这样的需求，你该如何实现？

当然，你可能会有各种各样的实现方式，比如你可以定义一个多个文件和文件夹组成的树形数据结构来实现，但是这种实现方式需要维护一个树形数据结构，不仅复杂而且非常不容易维护和扩展。

这里我们可以介绍一种非常典型的设计模式来实现这个需求：**组合模式**

## 模式的定义

***将对象组合成树形结构以表示"整体-部分"的层次结构，此模式使得用户对单个对象和组合对象的使用具有一致性！***

组合模式对单个对象(叶子对象)和组合对象(组合对象)具有一致性，它将对象组织到树结构中，可以用来描述整体与部分的关系。同时它也模糊了简单元素(叶子对象)和复杂元素(容器对象)的概念，使得客户能够像处理简单元素一样来处理复杂元素，从而使客户程序能够与复杂元素的内部结构解耦。

我们来分析一下文件与文件树的关系：
* 每个文件夹可以包含多个文件和文件夹 -- 整体与部分
* 对所有文件和文件夹的浏览对用户都一样 -- 单个对象和组合对象具有一致性

基于上面这两个特点，我们的文件树的完全可以用"组合模式"来实现。

## 组合模式的结构

![composite-mode-construct](https://tva1.sinaimg.cn/large/008i3skNgy1gt5ykjtji8j30i40aj3z8.jpg)

* **组件(Component)**: 使用接口或者抽象类描述了局部叶子节点和整体容器的所有共有操作。
* **叶子节点(Leaf)**: 是树的基本结构，是单个的叶子节点，不能再包含子节点。一般情况下，叶节点最终会完成大部分的实际工作，因为他们无法将工作指派给其他部分。
* **容器(Composite)**: 是包含叶节点或其他容器等子项目的单位。容器不知道子项目所属的具体类，它只通过通用的组件接口与其子项目交互。容器接收到请求后会将工作分配给自己的子项目， 处理中间结果， 然后将最终结果返回给客户端。
* **客户端(Client)**: 通过组件接口与所有项目交互。 因此， 客户端能以相同方式与树状结构中的简单或复杂项目交互。

## 组合模式的使用场景

* **如果你需要实现树状对象结构， 可以使用组合模式**

组合模式为你提供了两种共享公共接口的基本元素类型： 简单叶节点和复杂容器。 容器中可以包含叶节点和其他容器。 这使得你可以构建树状嵌套递归对象结构。

* **如果你希望客户端代码以相同方式处理简单和复杂元素， 可以使用该模式**

组合模式中定义的所有元素共用同一个接口。 在这一接口的帮助下， 客户端不必在意其所使用的对象的具体类。

## 组合模式优缺点

### 优点
* 你可以利用多态和递归机制更方便地使用复杂树结构。
* 开闭原则。 无需更改现有代码， 你就可以在应用中添加新元素， 使其成为对象树的一部分。

### 缺点
* 对于功能差异较大的类， 提供公共接口或许会有困难。 在特定情况下， 你需要过度一般化组件接口， 使其变得令人难以理解。
